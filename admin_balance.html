<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANK OF LK - Manager Pro (Top-up System)</title>
    <style>
        :root { --bank-blue: #0f172a; --bank-gold: #f59e0b; --bg: #020617; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        
        #lockScreen { position: fixed; inset: 0; background: var(--bank-blue); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: #1e293b; padding: 40px; border-radius: 20px; text-align: center; border: 1px solid var(--bank-gold); width: 300px; }

        .container { max-width: 900px; margin: auto; padding: 20px; display: none; }
        
        .search-container { position: sticky; top: 10px; z-index: 100; background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 30px; border: 1px solid var(--bank-gold); }
        .search-input { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #0f172a; color: white; outline: none; box-sizing: border-box; }

        .acc-card { 
            background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155;
        }

        .topup-img { width: 80px; height: 80px; border-radius: 8px; cursor: pointer; border: 1px solid var(--bank-gold); object-fit: cover; }
        .acc-info { display: flex; align-items: center; gap: 12px; }
        .acc-photo-small { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }

        .btn { padding: 8px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }
        .btn-approve { background: var(--success); color: white; }
        .btn-deposit { background: var(--bank-gold); color: black; }
        
        h2 { font-size: 1.1rem; color: var(--bank-gold); margin-top: 30px; border-left: 4px solid var(--bank-gold); padding-left: 10px; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-box">
        <h2>MANAGER LOGIN</h2>
        <input type="password" id="adminPass" placeholder="Passcode" style="width: 80%; padding: 10px; margin-bottom: 20px;">
        <button class="btn" style="background:var(--success); width: 90%; color:white;" onclick="checkLock()">Unlock</button>
    </div>
</div>

<div class="container" id="adminContent">
    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∑É‡∑è‡∂∏‡∑è‡∂¢‡∑í‡∂ö‡∂∫‡∑è‡∂ú‡∑ö ‡∂±‡∂∏ ‡∑Ñ‡∑ù ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∑ô‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..." oninput="searchAccounts()">
    </div>

    <h2 style="color: #60a5fa;">üì∏ Wallet Top-up ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä (Freelance Balance)</h2>
    <div id="topupList">‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...</div>

    <h2>üè¶ ‡∂±‡∑Ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂Ö‡∂∫‡∂Ø‡∑î‡∂∏‡∑ä‡∂¥‡∂≠‡∑ä</h2>
    <div id="pendingList"></div>

    <h2>üõ°Ô∏è ‡∑É‡∑í‡∂∫‡∂Ω‡∑î‡∂∏ ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫</h2>
    <div id="activeAccountsList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://frelance-work-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let allAccounts = {};

    function checkLock() {
        if(document.getElementById('adminPass').value === "1234") {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadData();
        } else { alert("Passcode ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!"); }
    }

    function loadData() {
        // Top-up Requests Load
        database.ref('wallet_topups').orderByChild('status').equalTo('Pending').on('value', snap => {
            const list = document.getElementById('topupList');
            const data = snap.val();
            let html = data ? "" : "<p style='color:gray; padding-left:15px;'>‡∂±‡∑Ä Top-up ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ì‡∂∏‡∑ä ‡∂±‡∑ê‡∂≠.</p>";
            if(data) {
                Object.keys(data).forEach(id => {
                    const req = data[id];
                    html += `
                    <div class="acc-card">
                        <div class="acc-info">
                            <img src="${req.screenshot}" class="topup-img" onclick="window.open('${req.screenshot}')">
                            <div>
                                <b>${req.name}</b><br>
                                <small>‡∂â‡∂Ω‡∑ä‡∂Ω‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: <span style="color:var(--bank-gold)">Rs. ${req.amount}</span></small><br>
                                <small>Acc No: ${req.accNo}</small>
                            </div>
                        </div>
                        <button class="btn btn-approve" onclick="approveTopup('${id}', '${req.accNo}', ${req.amount})">Approve & Pay</button>
                    </div>`;
                });
            }
            list.innerHTML = html;
        });

        // Other lists load (Applications & Accounts)
        database.ref('bank_applications').orderByChild('status').equalTo('Pending').on('value', snap => {
            const list = document.getElementById('pendingList');
            const data = snap.val();
            let html = data ? "" : "<p style='color:gray; padding-left:15px;'>‡∂±‡∑Ä ‡∂Ö‡∂∫‡∂Ø‡∑î‡∂∏‡∑ä‡∂¥‡∂≠‡∑ä ‡∂±‡∑ê‡∂≠.</p>";
            if(data) {
                Object.keys(data).forEach(id => {
                    const a = data[id];
                    html += `<div class="acc-card">
                        <div class="acc-info"><img src="${a.photo}" class="acc-photo-small"><div><b>${a.name}</b></div></div>
                        <button class="btn" style="background:var(--success); color:white;" onclick="approveQuick('${id}', '${a.name}', '${a.photo}')">Approve</button>
                    </div>`;
                });
            }
            list.innerHTML = html;
        });

        database.ref('bank_accounts').on('value', snap => {
            allAccounts = snap.val() || {};
            renderAccountList(allAccounts, 'activeAccountsList');
        });
    }

    // --- Approve Top-up Function ---
    async function approveTopup(requestId, accNo, amount) {
        if(!confirm(`‡∂ª‡∑î. ${amount} ‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂∏‡∑ô‡∂∏ ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ß (Acc: ${accNo}) ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?`)) return;

        try {
            // 1. ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ö ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ô‡∂± ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            const accountRef = database.ref('bank_accounts/' + accNo);
            const snapshot = await accountRef.once('value');
            if(!snapshot.exists()) return alert("‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö!");

            const currentBalance = Number(snapshot.val().balance) || 0;
            const newBalance = currentBalance + Number(amount);

            // 2. ‡∑Å‡∑ö‡∑Ç‡∂∫ Update ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            await accountRef.update({ balance: newBalance });

            // 3. Request ‡∂ë‡∂ö 'Approved' ‡∂Ω‡∑ô‡∑É ‡∑É‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            await database.ref('wallet_topups/' + requestId).update({ status: 'Approved' });

            // 4. Transaction ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫‡∂ß ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
            await database.ref('transactions/' + accNo).push({
                type: "Deposit",
                amount: amount,
                date: new Date().toLocaleString(),
                description: "Freelance Wallet Top-up"
            });

            alert("Top-up ‡∂ë‡∂ö ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‡∑Å‡∑ö‡∑Ç‡∂∫ ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∑Ä‡∑í‡∂∫.");
        } catch (e) {
            alert("‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑í: " + e.message);
        }
    }

    function renderAccountList(data, elementId) {
        const list = document.getElementById(elementId);
        let html = "";
        Object.keys(data).reverse().forEach(accNo => {
            const acc = data[accNo];
            html += `<div class="acc-card">
                <div class="acc-info">
                    <img src="${acc.photo}" class="acc-photo-small">
                    <div><b>${acc.name}</b><br><small>Bal: Rs. ${Number(acc.balance).toLocaleString()}</small></div>
                </div>
                <div>
                    <button class="btn btn-deposit" onclick="manageBalance('${accNo}', ${acc.balance})">Deposit</button>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    // (‡∑É‡∑ô‡∑Ä‡∑î‡∂∏‡∑ä ‡∑É‡∑Ñ ‡∂Ö‡∂±‡∑ô‡∂ö‡∑î‡∂≠‡∑ä ‡∂¥‡∑ê‡∂ª‡∂´‡∑í functions ‡∂∏‡∑ô‡∂≠‡∑ê‡∂±‡∑í‡∂±‡∑ä ‡∂¥‡∑Ñ‡∑Ö‡∂ß...)
    async function manageBalance(accNo, currentBal) {
        const amount = prompt("‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂∏‡∑î‡∂Ø‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Rs):");
        if (!amount || isNaN(amount)) return;
        const newBalance = Number(currentBal) + Number(amount);
        await database.ref('bank_accounts/' + accNo).update({ balance: newBalance });
        alert("‡∂≠‡∑ê‡∂±‡∑ä‡∂¥‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
    }

    function searchAccounts() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        if(query.length < 1) { resultsDiv.style.display = 'none'; return; }
        let filtered = {};
        Object.keys(allAccounts).forEach(key => {
            if(allAccounts[key].name.toLowerCase().includes(query) || key.includes(query)) filtered[key] = allAccounts[key];
        });
        resultsDiv.style.display = 'block';
        renderAccountList(filtered, 'searchList');
    }

    async function approveQuick(id, name, photo) {
        const accNo = prompt(name + " ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∑ä ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±:");
        if (!accNo) return;
        await database.ref('bank_accounts/' + accNo).set({ name: name, accNo: accNo, photo: photo, balance: 0, status: "Active" });
        await database.ref('bank_applications/' + id).update({ status: "Approved" });
    }
</script>
</body>
</html>
